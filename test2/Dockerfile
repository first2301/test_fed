FROM ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive

# íŒ¨í‚¤ì§€ ì„¤ì¹˜ (apt-get updateì™€ installì„ í•œ ë²ˆì— ë¬¶ëŠ” ê²ƒì´ ìºì‹±/ìš©ëŸ‰ ê´€ë¦¬ì— ìœ ë¦¬í•¨)
RUN apt-get update && apt-get install -y \
    openssh-server \
    python3 \
    python3-pip \
    python3-venv \
    iputils-ping \
    curl \
    net-tools \
    && rm -rf /var/lib/apt/lists/*

# ê°€ìƒí™˜ê²½ ì„¤ì •
RUN python3 -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Python íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN pip install --upgrade pip setuptools wheel 
RUN pip install flwr[simulation]>=1.23.0 \
    flwr-datasets[vision]>=0.5.0 \
    scikit-learn>=1.6.1

# ì‘ì—… ë””ë ‰í† ë¦¬ ìƒì„±
RUN mkdir -p /root/distributed

# SSH ì„¤ì •
RUN mkdir -p /var/run/sshd
RUN ssh-keygen -A

# SSH ì ‘ì† í—ˆìš© ì„¤ì •
RUN sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config && \
    sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config && \
    sed -ri 's/UsePAM yes/#UsePAM yes/g' /etc/ssh/sshd_config

# ğŸš¨ ì£¼ì˜: ë¹„ë°€ë²ˆí˜¸ëŠ” 'password'ì…ë‹ˆë‹¤. ì™¸ë¶€(0.0.0.0) í¬íŠ¸ ê°œë°© ê¸ˆì§€!
RUN echo 'root:password' | chpasswd

# [ë³€ê²½ì ] ë³„ë„ì˜ start.sh ìŠ¤í¬ë¦½íŠ¸ ì—†ì´ SSH ë°ëª¬ì„ ì§ì ‘ ì‹¤í–‰
# -D ì˜µì…˜: ë°ëª¬ì„ ë°±ê·¸ë¼ìš´ë“œê°€ ì•„ë‹Œ í¬ê·¸ë¼ìš´ë“œë¡œ ì‹¤í–‰í•˜ì—¬ ì»¨í…Œì´ë„ˆê°€ êº¼ì§€ì§€ ì•Šê²Œ í•¨
# -e ì˜µì…˜: ë¡œê·¸ë¥¼ í‘œì¤€ ì˜¤ë¥˜(stderr)ë¡œ ì¶œë ¥í•˜ì—¬ 'docker logs'ë¡œ í™•ì¸ ê°€ëŠ¥í•˜ê²Œ í•¨
CMD ["/usr/sbin/sshd", "-D", "-e"]